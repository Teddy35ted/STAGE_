<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API Admin - Laala</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            border: 1px solid #ddd;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
        }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .log {
            background: #2d3748;
            color: #a0aec0;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üß™ Test Syst√®me Admin - Laala</h1>
    <p>Tests pour v√©rifier l'authentification admin et le syst√®me de notifications</p>

    <div class="test-section info">
        <h2>üìã Informations de test</h2>
        <p><strong>Email admin:</strong> tedkouevi701@gmail.com</p>
        <p><strong>Mot de passe admin:</strong> feiderus</p>
        <p><strong>Serveur:</strong> http://localhost:3002</p>
    </div>

    <div class="test-section">
        <h2>üîß 1. Initialisation Admin</h2>
        <button onclick="initAdmin()">Cr√©er Admin</button>
        <div id="init-result"></div>
    </div>

    <div class="test-section">
        <h2>üîê 2. Test Connexion Admin</h2>
        <button onclick="testLogin()">Tester Connexion</button>
        <div id="login-result"></div>
    </div>

    <div class="test-section">
        <h2>üìù 3. Test Demande de Compte</h2>
        <button onclick="testAccountRequest()">Cr√©er Demande</button>
        <div id="request-result"></div>
    </div>

    <div class="test-section">
        <h2>üìã 4. Test R√©cup√©ration Demandes</h2>
        <button onclick="testGetRequests()">Voir Demandes</button>
        <div id="requests-result"></div>
    </div>

    <div class="test-section">
        <h2>üìÑ Logs de Test</h2>
        <div id="logs" class="log"></div>
        <button onclick="clearLogs()">Effacer Logs</button>
    </div>

    <script>
        let adminToken = null;

        function log(message) {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logsDiv.textContent += `[${timestamp}] ${message}\n`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(message);
        }

        function clearLogs() {
            document.getElementById('logs').textContent = '';
        }

        function showResult(elementId, content, success = true) {
            const element = document.getElementById(elementId);
            element.innerHTML = content;
            element.className = success ? 'success' : 'error';
        }

        async function initAdmin() {
            log('üîß Tentative d\'initialisation admin...');
            try {
                const response = await fetch('/api/admin/init', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'tedkouevi701@gmail.com',
                        password: 'feiderus',
                        name: 'Administrateur Principal'
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    log('‚úÖ Admin cr√©√© avec succ√®s !');
                    showResult('init-result', `
                        <h3>‚úÖ Admin cr√©√© avec succ√®s !</h3>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `);
                } else {
                    log(`‚ùå Erreur cr√©ation admin: ${result.error}`);
                    showResult('init-result', `
                        <h3>‚ùå Erreur</h3>
                        <p>${result.error}</p>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `, false);
                }
            } catch (error) {
                log(`‚ùå Erreur r√©seau: ${error.message}`);
                showResult('init-result', `<h3>‚ùå Erreur r√©seau</h3><p>${error.message}</p>`, false);
            }
        }

        async function testLogin() {
            log('üîê Test de connexion admin...');
            try {
                const response = await fetch('/api/admin/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: 'tedkouevi701@gmail.com',
                        password: 'feiderus'
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    adminToken = result.token;
                    log('‚úÖ Connexion admin r√©ussie !');
                    showResult('login-result', `
                        <h3>‚úÖ Connexion r√©ussie !</h3>
                        <p><strong>Email:</strong> ${result.admin?.email}</p>
                        <p><strong>R√¥le:</strong> ${result.admin?.role}</p>
                        <p><strong>Token re√ßu:</strong> ${adminToken ? 'Oui' : 'Non'}</p>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `);
                } else {
                    log(`‚ùå √âchec connexion: ${result.error}`);
                    showResult('login-result', `
                        <h3>‚ùå √âchec de connexion</h3>
                        <p>${result.error}</p>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `, false);
                }
            } catch (error) {
                log(`‚ùå Erreur r√©seau: ${error.message}`);
                showResult('login-result', `<h3>‚ùå Erreur r√©seau</h3><p>${error.message}</p>`, false);
            }
        }

        async function testAccountRequest() {
            log('üìù Test cr√©ation demande de compte...');
            try {
                const testEmail = `test.user.${Date.now()}@example.com`;
                const response = await fetch('/api/auth/request-account', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: testEmail,
                        role: 'animateur'
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    log(`‚úÖ Demande cr√©√©e pour ${testEmail}`);
                    showResult('request-result', `
                        <h3>‚úÖ Demande cr√©√©e avec succ√®s !</h3>
                        <p><strong>Email:</strong> ${testEmail}</p>
                        <p><strong>ID demande:</strong> ${result.requestId}</p>
                        <p><strong>R√¥le:</strong> animateur</p>
                        <p>üîî Les admins doivent recevoir une notification</p>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `);
                } else {
                    log(`‚ùå Erreur cr√©ation demande: ${result.error}`);
                    showResult('request-result', `
                        <h3>‚ùå Erreur cr√©ation demande</h3>
                        <p>${result.error}</p>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `, false);
                }
            } catch (error) {
                log(`‚ùå Erreur r√©seau: ${error.message}`);
                showResult('request-result', `<h3>‚ùå Erreur r√©seau</h3><p>${error.message}</p>`, false);
            }
        }

        async function testGetRequests() {
            log('üìã Test r√©cup√©ration demandes...');
            
            if (!adminToken) {
                log('‚ùå Pas de token admin - connectez-vous d\'abord');
                showResult('requests-result', `<h3>‚ùå Erreur</h3><p>Pas de token admin. Connectez-vous d'abord.</p>`, false);
                return;
            }

            try {
                const response = await fetch('/api/admin/account-requests', {
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    log(`‚úÖ ${result.requests?.length || 0} demande(s) r√©cup√©r√©e(s)`);
                    showResult('requests-result', `
                        <h3>‚úÖ Demandes r√©cup√©r√©es avec succ√®s !</h3>
                        <p><strong>Nombre de demandes:</strong> ${result.requests?.length || 0}</p>
                        ${result.requests && result.requests.length > 0 ? `
                            <h4>Derni√®re demande:</h4>
                            <ul>
                                <li><strong>Email:</strong> ${result.requests[0].email}</li>
                                <li><strong>R√¥le:</strong> ${result.requests[0].role}</li>
                                <li><strong>Statut:</strong> ${result.requests[0].status}</li>
                                <li><strong>Date:</strong> ${new Date(result.requests[0].requestDate).toLocaleString()}</li>
                            </ul>
                        ` : '<p>Aucune demande trouv√©e</p>'}
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `);
                } else {
                    log(`‚ùå Erreur r√©cup√©ration: ${result.error}`);
                    showResult('requests-result', `
                        <h3>‚ùå Erreur r√©cup√©ration</h3>
                        <p>${result.error}</p>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `, false);
                }
            } catch (error) {
                log(`‚ùå Erreur r√©seau: ${error.message}`);
                showResult('requests-result', `<h3>‚ùå Erreur r√©seau</h3><p>${error.message}</p>`, false);
            }
        }

        // Initialiser les logs
        log('üß™ Tests Syst√®me Admin Laala - D√©marr√©s');
        log('üìã Credentials: tedkouevi701@gmail.com / feiderus');
        log('üöÄ Pr√™t pour les tests !');
    </script>
</body>
</html>
